# Copyright 2020 Hewlett Packard Enterprise Development LP
---
- name: Configure CAN v2 on UANs
  block:

  - debug:
     msg: "Customer Access Network - {{ customer_access_network }}"

  # Uses the nth IP of the customer_access_network subnet where n is the last octet of the NMN IP
  # FIXME TODO: get the CAN IP from SLS - CASMCMS-5645
  - name: Get CAN IP
    set_fact:
        can_ip: "{{ customer_access_network | ipaddr(octet|int) | ipaddr('address') }}"

  # FIXME TODO: get the CAN Prefix from SLS - CASMCMS-5645
  - name: Get CAN Prefix
    set_fact:
        can_prefix: "{{ customer_access_network | ipaddr('prefix') }}"

  # FIXME TODO: get the Mountain NMN network info from SLS or anything but networks.yml - CASMCMS-5660
  - name: Get Mountain NMN network
    when: networks.node_management.blocks.ipv4[1].network is defined
    set_fact:
      mountain_network: networks.node_management.blocks.ipv4[1].network

  - name: Get MTL IP
    set_fact:
      mtl_ip: "{{ lookup('dig', ansible_hostname | regex_replace('(-nmn)$|(-can)$') + '-mtl.') }}"

  - debug:
      msg: "NMN IP - {{ nmn_ip }}; CAN IP - {{ can_ip }}; MTL IP - {{ mtl_ip }}"

  - name: Configure bond slaves
    copy:
      src: ifcfg-bond-slaves
      dest: "/etc/sysconfig/network/ifcfg-{{ item }}"
      owner: root
      group: root
      mode: '0644'
    loop: "{{ uan_can_devices }}"

  - name: Configure ifcfg-bond0
    template:
      src: ifcfg-bond0.j2
      dest: /etc/sysconfig/network/ifcfg-bond0
      mode: 0644

  - name: Configure ifcfg-vlan007
    template:
      src: ifcfg-vlan007.j2
      dest: /etc/sysconfig/network/ifcfg-vlan007
      mode: 0644

  - name: Configure ifroute-vlan007
    template:
      src: ifroute-vlan007.j2
      dest: /etc/sysconfig/network/ifroute-vlan007
      owner: root
      mode: 0600

  - name: Ensure wicked script directories exist
    file:
      path: "/etc/wicked/scripts/{{ item }}"
      state: directory
    loop: [ "post-up", "post-down" ]

  - name: Configure can-up.sh
    template:
      src: can-up.j2
      dest: "/etc/wicked/scripts/post-up/can-up.sh"
      owner: root
      mode: 0755

  - name: Configure can-down.sh
    template:
      src: can-down.j2
      dest: "/etc/wicked/scripts/post-down/can-down.sh"
      owner: root
      mode: 0755

  - name: ifdown vlan007 and eth0 interfaces to set the interface config and routes
    shell: "wicked ifdown {{ item }};sleep 5"
    changed_when: result.rc == 0
    failed_when: result.rc != 0
    register: result
    with_items:
      - eth0
      - vlan007

  - name: ifup vlan007 and eth0 interfaces to set the interface config and routes
    shell: "wicked ifup {{ item }};sleep 5"
    changed_when: result.rc == 0
    failed_when: result.rc != 0
    register: result
    with_items:
      - vlan007
      - eth0

  - name: Check that we have the default route we are expecting
    shell: "ip route | grep default | grep -q '{{ customer_access_gateway }}'"
    failed_when: result.rc != 0
    register: result

  - name: Check that the vlan007 interface has the expected IP
    shell: "ip addr show vlan007 | grep -q {{ can_ip }}/{{ can_prefix }}"
    failed_when: result.rc != 0
    register: result

  when:
    - customer_access_network is defined
    - customer_access_gateway is defined

